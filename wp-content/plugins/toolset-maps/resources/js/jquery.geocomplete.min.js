(function($,window,document,undefined){var defaults={bounds:true,strictBounds:false,country:null,map:false,details:false,detailsAttribute:"name",detailsScope:null,autoselect:true,location:false,mapOptions:{zoom:14,scrollwheel:false,mapTypeId:"roadmap"},markerOptions:{draggable:false},maxZoom:16,types:["geocode"],blur:false,geocodeAfterResult:false,restoreValueAfterBlur:false};var componentTypes=("street_address route intersection political "+"country administrative_area_level_1 administrative_area_level_2 "+"administrative_area_level_3 colloquial_area locality sublocality "+"neighborhood premise subpremise postal_code natural_feature airport "+"park point_of_interest post_box street_number floor room "+"lat lng viewport location "+"formatted_address location_type bounds").split(" ");var placesDetails=("id place_id url website vicinity reference name rating "+"international_phone_number icon formatted_phone_number").split(" ");function GeoComplete(input,options){this.options=$.extend(true,{},defaults,options);if(options&&options.types){this.options.types=options.types}this.input=input;this.$input=$(input);this._defaults=defaults;this._name="geocomplete";this.apiVersion=null;this.isAPITested=false;this.init()}$.extend(GeoComplete.prototype,{init:function(){this.initMap();this.initMarker();this.initGeocoder();this.initDetails();this.initLocation()},initMap:function(){if(!this.options.map){return}if(typeof this.options.map.setCenter=="function"){this.map=this.options.map;return}this.map=new google.maps.Map($(this.options.map)[0],this.options.mapOptions);google.maps.event.addListener(this.map,"click",$.proxy(this.mapClicked,this));google.maps.event.addListener(this.map,"dragend",$.proxy(this.mapDragged,this));google.maps.event.addListener(this.map,"idle",$.proxy(this.mapIdle,this));google.maps.event.addListener(this.map,"zoom_changed",$.proxy(this.mapZoomed,this))},initMarker:function(){if(!this.map){return}var options=$.extend(this.options.markerOptions,{map:this.map});if(options.disabled){return}this.marker=new google.maps.Marker(options);google.maps.event.addListener(this.marker,"dragend",$.proxy(this.markerDragged,this))},testAPIVersion:async function(){if(this.isAPITested){return this.apiVersion!=="none"}try{if(google.maps.places&&google.maps.places.AutocompleteSuggestion){console.debug("Testing new AutocompleteSuggestion API...");const request={input:"Phoenix",sessionToken:new google.maps.places.AutocompleteSessionToken};const{suggestions}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(request);if(suggestions&&suggestions.length>0){this.apiVersion="new";this.isAPITested=true;console.debug("New AutocompleteSuggestion API is working - using new API");return true}}}catch(newApiError){console.warn("New API failed:",newApiError.message)}try{console.log("Toolset Notice: Falling back to the classic AutocompleteService API - you may see deprecation notices."+"For best results, please create a new API key or enable the latest Places API in your Google Cloud Console.");const service=new google.maps.places.AutocompleteService;await new Promise((resolve,reject)=>{service.getPlacePredictions({input:"Phoenix"},function(predictions,status){if(status===google.maps.places.PlacesServiceStatus.OK&&predictions&&predictions.length>0){console.debug("Classic AutocompleteService API is working - using classic API");resolve()}else{reject(new Error("Classic API failed with status: "+status))}})});this.apiVersion="classic";this.isAPITested=true;return true}catch(classicError){console.error("Both APIs failed. Autocomplete will not be available.");console.error("Classic API error:",classicError.message);this.apiVersion="none";this.isAPITested=true;return false}},initGeocoder:async function(){await this.testAPIVersion();if(this.apiVersion==="none"){console.warn("No autocomplete API available, skipping autocomplete initialization");this.geocoder=new google.maps.Geocoder;return}var selected=false;var options={types:this.options.types,bounds:this.options.bounds===true?null:this.options.bounds,componentRestrictions:this.options.componentRestrictions,strictBounds:this.options.strictBounds};if(this.options.country){options.componentRestrictions={country:this.options.country}}if(this.apiVersion==="classic"){this.autocomplete=new google.maps.places.Autocomplete(this.input,options);this.geocoder=new google.maps.Geocoder;if(this.map&&this.options.bounds===true){this.autocomplete.bindTo("bounds",this.map)}google.maps.event.addListener(this.autocomplete,"place_changed",$.proxy(this.placeChanged,this))}else if(this.apiVersion==="new"){this.geocoder=new google.maps.Geocoder;this.initCustomAutocomplete(options)}this.$input.on("keypress."+this._name,function(event){if(event.keyCode===13){if(self.apiVersion==="new"&&self.options.autoselect&&!self.selected){if(self.selectedIndex>=0||self.currentSuggestions&&self.currentSuggestions.length>0){event.preventDefault();if(self.selectedIndex>=0){self.selectSuggestion(self.selectedIndex)}else{self.selectSuggestion(0)}return false}}return false}});if(this.options.geocodeAfterResult===true){this.$input.bind("keypress."+this._name,$.proxy(function(){if(event.keyCode!=9&&this.selected===true){this.selected=false}},this))}this.$input.bind("geocode."+this._name,$.proxy(function(){this.find()},this));this.$input.bind("geocode:result."+this._name,$.proxy(function(){this.lastInputVal=this.$input.val()},this));if(this.options.blur===true){this.$input.on("blur."+this._name,$.proxy(function(){if(this.options.geocodeAfterResult===true&&this.selected===true){return}if(this.options.restoreValueAfterBlur===true&&this.selected===true){setTimeout($.proxy(this.restoreLastValue,this),0)}else{this.find()}},this))}},initCustomAutocomplete:function(options){var self=this;var debounceTimer;var currentSuggestions=[];var selectedIndex=-1;this.sessionToken=new google.maps.places.AutocompleteSessionToken;if(!$("#geocomplete-dropdown-styles").length){var styles='<style id="geocomplete-dropdown-styles">'+".pac-container { background-color: #fff; position: absolute; z-index: 1000; border-radius: 2px; border-top: 1px solid #d9d9d9; font-family: Arial, sans-serif; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; overflow: hidden; }"+".pac-item { cursor: default; padding: 0 4px; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; line-height: 30px; text-align: left; border-top: 1px solid #e6e6e6; font-size: 11px; color: #999; }"+".pac-item:hover, .pac-item-selected { background-color: #fafafa; }"+".pac-item-query { font-size: 13px; padding-right: 3px; color: #000; }"+".pac-icon { width: 15px; height: 20px; margin-right: 7px; margin-top: 6px; display: inline-block; vertical-align: top; background-image: url(https://maps.gstatic.com/mapfiles/api-3/images/autocomplete-icons.png); background-size: 34px; }"+".pac-icon-marker { background-position: -1px -161px; }"+".hdpi .pac-icon { background-image: url(https://maps.gstatic.com/mapfiles/api-3/images/autocomplete-icons_hdpi.png); }"+"</style>";$("head").append(styles)}this.$dropdown=$('<div class="pac-container pac-logo" style="display: none;"></div>');$("body").append(this.$dropdown);function positionDropdown(){var offset=self.$input.offset();var height=self.$input.outerHeight();self.$dropdown.css({top:offset.top+height,left:offset.left,width:self.$input.outerWidth()})}this.$input.on("input."+this._name,function(){clearTimeout(debounceTimer);var value=$(this).val();self.selected=false;if(value.length<2){self.$dropdown.hide();currentSuggestions=[];selectedIndex=-1;return}debounceTimer=setTimeout(function(){self.fetchSuggestions(value,options)},300)});this.$input.on("keydown."+this._name,function(e){if(!self.$dropdown.is(":visible")||currentSuggestions.length===0)return;switch(e.keyCode){case 38:e.preventDefault();selectedIndex=Math.max(-1,selectedIndex-1);self.updateSelection();break;case 40:e.preventDefault();selectedIndex=Math.min(currentSuggestions.length-1,selectedIndex+1);self.updateSelection();break;case 13:if(selectedIndex>=0){e.preventDefault();self.selectSuggestion(selectedIndex)}break;case 27:self.$dropdown.hide();selectedIndex=-1;break}});this.$dropdown.on("click",".pac-item",function(e){e.preventDefault();var index=$(this).data("index");self.selectSuggestion(index)});$(document).on("click."+this._name,function(e){if(!$(e.target).closest(self.$input).length&&!$(e.target).closest(self.$dropdown).length){self.$dropdown.hide();selectedIndex=-1}});this.$input.on("blur."+this._name,function(){setTimeout(function(){if(!self.selected&&self.$input.val()){self.find(self.$input.val())}},200)});$(window).on("resize."+this._name,positionDropdown);this.currentSuggestions=currentSuggestions;this.selectedIndex=selectedIndex;this.positionDropdown=positionDropdown},updateSelection:function(){this.$dropdown.find(".pac-item").removeClass("pac-item-selected");if(this.selectedIndex>=0){this.$dropdown.find(".pac-item").eq(this.selectedIndex).addClass("pac-item-selected")}},selectSuggestion:async function(index){if(index<0||index>=this.currentSuggestions.length)return;var suggestion=this.currentSuggestions[index];this.$dropdown.hide();this.selected=true;try{const place=await suggestion.placePrediction.toPlace();await place.fetchFields({fields:["displayName","formattedAddress","location","viewport","addressComponents","id","types"]});this.$input.val(place.formattedAddress||place.displayName);var result={formatted_address:place.formattedAddress||place.displayName,geometry:{location:place.location,viewport:place.viewport},place_id:place.id,address_components:place.addressComponents||[],types:place.types||[]};this.sessionToken=new google.maps.places.AutocompleteSessionToken;this.update(result)}catch(error){console.error("Error fetching place details:",error);this.selected=false}},fetchSuggestions:async function(input,options){try{const request={input:input,sessionToken:this.sessionToken};if(options.bounds){request.locationBias=options.bounds}if(options.componentRestrictions&&options.componentRestrictions.country){request.region=options.componentRestrictions.country}const{suggestions}=await google.maps.places.AutocompleteSuggestion.fetchAutocompleteSuggestions(request);if(suggestions&&suggestions.length>0){this.currentSuggestions=suggestions;this.selectedIndex=-1;this.renderDropdown(suggestions)}else{this.$dropdown.hide();this.currentSuggestions=[]}}catch(error){console.error("Error fetching suggestions:",error);this.$dropdown.hide()}},renderDropdown:function(suggestions){var html="";suggestions.forEach(function(suggestion,index){var prediction=suggestion.placePrediction;var mainText=prediction.text?prediction.text.text:"";var secondaryText=prediction.secondaryText?prediction.secondaryText.text:"";html+='<div class="pac-item" data-index="'+index+'">';html+='<span class="pac-icon pac-icon-marker"></span>';html+='<span class="pac-item-query">';if(prediction.structuredFormat&&prediction.structuredFormat.mainText){html+=prediction.structuredFormat.mainText.text}else{html+=mainText}html+="</span>";if(secondaryText){html+="<span> - "+secondaryText+"</span>"}html+="</div>"});this.$dropdown.html(html);this.positionDropdown();this.$dropdown.show()},initDetails:function(){if(!this.options.details){return}if(this.options.detailsScope){var $details=$(this.input).parents(this.options.detailsScope).find(this.options.details)}else{var $details=$(this.options.details)}var attribute=this.options.detailsAttribute,details={};function setDetail(value){details[value]=$details.find("["+attribute+"="+value+"]")}$.each(componentTypes,function(index,key){setDetail(key);setDetail(key+"_short")});$.each(placesDetails,function(index,key){setDetail(key)});this.$details=$details;this.details=details},initLocation:function(){var location=this.options.location,latLng;if(!location){return}if(typeof location=="string"){this.find(location);return}if(location instanceof Array){latLng=new google.maps.LatLng(location[0],location[1])}if(location instanceof google.maps.LatLng){latLng=location}if(latLng){if(this.map){this.map.setCenter(latLng)}if(this.marker){this.marker.setPosition(latLng)}}},destroy:function(){if(this.map){google.maps.event.clearInstanceListeners(this.map);google.maps.event.clearInstanceListeners(this.marker)}if(this.autocomplete){this.autocomplete.unbindAll();google.maps.event.clearInstanceListeners(this.autocomplete)}if(this.$dropdown){this.$dropdown.remove()}google.maps.event.clearInstanceListeners(this.input);this.$input.removeData();this.$input.off(this._name);this.$input.unbind("."+this._name);$(document).off("."+this._name);$(window).off("."+this._name)},find:function(address){this.geocode({address:address||this.$input.val()})},geocode:function(request){if(!request.address){return}if(this.options.bounds&&!request.bounds){if(this.options.bounds===true){request.bounds=this.map&&this.map.getBounds()}else{request.bounds=this.options.bounds}}if(this.options.country){request.region=this.options.country}this.geocoder.geocode(request,$.proxy(this.handleGeocode,this))},selectFirstResult:function(){if(this.apiVersion==="new"&&this.currentSuggestions&&this.currentSuggestions.length>0){this.selectSuggestion(0);return this.$input.val()}var selected="";if($(".pac-item-selected")[0]){selected="-selected"}var $span1=$(".pac-container:visible .pac-item"+selected+":first span:nth-child(2)").text();var $span2=$(".pac-container:visible .pac-item"+selected+":first span:nth-child(3)").text();var firstResult=$span1;if($span2){firstResult+=" - "+$span2}this.$input.val(firstResult);return firstResult},restoreLastValue:function(){if(this.lastInputVal){this.$input.val(this.lastInputVal)}},handleGeocode:function(results,status){if(status===google.maps.GeocoderStatus.OK){var result=results[0];this.$input.val(result.formatted_address);this.update(result);if(results.length>1){this.trigger("geocode:multiple",results)}}else{this.trigger("geocode:error",status)}},trigger:function(event,argument){this.$input.trigger(event,[argument])},center:function(geometry){if(geometry.viewport){this.map.fitBounds(geometry.viewport);if(this.map.getZoom()>this.options.maxZoom){this.map.setZoom(this.options.maxZoom)}}else{this.map.setZoom(this.options.maxZoom);this.map.setCenter(geometry.location)}if(this.marker){this.marker.setPosition(geometry.location);this.marker.setAnimation(this.options.markerOptions.animation)}},update:function(result){if(this.map){this.center(result.geometry)}if(this.$details){this.fillDetails(result)}this.trigger("geocode:result",result)},fillDetails:function(result){var data={},geometry=result.geometry,viewport=geometry.viewport,bounds=geometry.bounds;$.each(result.address_components,function(index,object){var name=object.types[0];$.each(object.types,function(index,name){data[name]=object.long_name;data[name+"_short"]=object.short_name})});$.each(placesDetails,function(index,key){data[key]=result[key]});$.extend(data,{formatted_address:result.formatted_address,location_type:geometry.location_type||"PLACES",viewport:viewport,bounds:bounds,location:geometry.location,lat:geometry.location.lat(),lng:geometry.location.lng()});$.each(this.details,$.proxy(function(key,$detail){var value=data[key];this.setDetail($detail,value)},this));this.data=data},setDetail:function($element,value){if(value===undefined){value=""}else if(typeof value.toUrlValue=="function"){value=value.toUrlValue()}if($element.is(":input")){$element.val(value)}else{$element.text(value)}},markerDragged:function(event){this.trigger("geocode:dragged",event.latLng)},mapClicked:function(event){this.trigger("geocode:click",event.latLng)},mapDragged:function(event){this.trigger("geocode:mapdragged",this.map.getCenter())},mapIdle:function(event){this.trigger("geocode:idle",this.map.getCenter())},mapZoomed:function(event){this.trigger("geocode:zoom",this.map.getZoom())},resetMarker:function(){this.marker.setPosition(this.data.location);this.setDetail(this.details.lat,this.data.location.lat());this.setDetail(this.details.lng,this.data.location.lng())},placeChanged:function(){if(!this.autocomplete){return}var place=this.autocomplete.getPlace();this.selected=true;if(!place.geometry){if(this.options.autoselect){var autoSelection=this.selectFirstResult();this.find(autoSelection)}}else{this.update(place)}}});$.fn.geocomplete=function(options){var attribute="plugin_geocomplete";if(typeof options=="string"){var instance=$(this).data(attribute)||$(this).geocomplete().data(attribute),prop=instance[options];if(typeof prop=="function"){prop.apply(instance,Array.prototype.slice.call(arguments,1));return $(this)}else{if(arguments.length==2){prop=arguments[1]}return prop}}else{return this.each(function(){var instance=$.data(this,attribute);if(!instance){instance=new GeoComplete(this,options);$.data(this,attribute,instance)}})}}})(jQuery,window,document);